<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>일본어 작문 연습 · 문제=일본어 / 정답=뜻·발음</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{ --bg:#f7f9fc; --text:#0f172a; --muted:#5b6476; --card:#ffffff; --ring:#d9e1ff; --accent:#2563eb; --shadow:0 10px 30px rgba(7,14,48,.06); }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Pretendard, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; background:var(--bg); color:var(--text) }
  .container{ max-width:900px; margin:26px auto; padding:0 16px }
  h1{ margin:0 0 12px; font-size:28px }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px }
  .btn{ border:1px solid #cfd7ee; background:#fff; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; box-shadow:var(--shadow) }
  .btn:hover{ background:#f3f6ff }
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .btn.ghost{ background:#f6f8ff }
  input[type="number"]{ width:72px; padding:8px 10px; border:1px solid #d4dcf4; border-radius:10px; font-weight:600; box-shadow:var(--shadow) }
  .hint{ color:var(--muted); font-size:13px }
  .card{ background:var(--card); border:1px solid #e6ecff; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:18px 0 }
  .question{ font-size:22px; font-weight:800; letter-spacing:.2px; padding:16px; border:1px solid #e4e9fb; border-radius:12px; background:#fbfdff }
  .answer{ position:relative; margin-top:14px; padding:18px; border-radius:12px; background:#f7f9ff; color:#10162d; border:1px dashed #cdd7fb }
  .answer.hidden .blur{ filter: blur(7px); opacity:.65 }
  .answer .label{ font-size:12px; color:var(--muted); margin-bottom:6px }
  .answer .line{ font-size:18px; font-weight:700 }
  .row{ display:flex; justify-content:flex-end; margin-top:12px }
  .pill{ border:1px solid #d4dcf4; background:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:var(--shadow) }
  .top-note{ margin:4px 0 18px; font-size:12px; color:var(--muted) }
  input[type=file]{ display:none }
</style>
</head>
<body>
  <div class="container">
    <h1>일본어 작문 연습</h1>
    <div class="toolbar">
      <button class="btn" id="shuffleBtn">무작위 섞기</button>
      <label class="hint">반복:</label>
      <input id="repeatInput" type="number" min="1" value="1" />
      <label class="btn" for="xlsxInput">파일 선택</label>
      <input id="xlsxInput" type="file" accept=".xlsx,.xls" />
      <button class="btn" id="revealAll">전체 정답 보기</button>
      <button class="btn" id="hideAll">전체 가리기</button>
      <span class="top-note">엑셀(<b>japanese.xlsx</b>) A열=일본어, B열=후리가나, C열=뜻</span>
    </div>

    <div id="list"></div>
  </div>

<script>
  // 기본 데이터 (엑셀 로딩 실패 시 사용되는 fallback)
  let baseData = [
    { 일본어: 'さすが', 뜻: '역시', 발음: '사스가' },
    { 일본어: 'えらい', 뜻: '대단해', 발음: '에라이' },
    { 일본어: 'すばらしい', 뜻: '훌륭해', 발음: '스바라시~' },
    { 일본어: '天才だよ', 뜻: '천재야', 발음: '텐사이 다요' },
    { 일본어: 'とても上手', 뜻: '엄청 잘하네', 발음: '토테모 조~즈' },
    { 일본어: 'やっぱり', 뜻: '역시', 발음: '얍빠리' },
  ];

  const $ = (id)=>document.getElementById(id);
  const listEl = $('list');

  function makeCard(item){
    const wrap = document.createElement('div');
    wrap.className = 'card';

    const q = document.createElement('div');
    q.className = 'question';
    q.textContent = item['일본어'] || item['A'] || Object.values(item)[0] || '';

    const a = document.createElement('div');
    a.className = 'answer hidden';

    const meanRow = document.createElement('div');
    meanRow.innerHTML = `<div class="label">뜻</div><div class="line blur">${item['뜻'] ?? item['B'] ?? Object.values(item)[1] ?? ''}</div>`;

    const pronRow = document.createElement('div');
    pronRow.style.marginTop = '8px';
    pronRow.innerHTML = `<div class="label">발음</div><div class="line blur">${item['발음'] ?? item['C'] ?? Object.values(item)[2] ?? ''}</div>`;

    a.appendChild(meanRow); a.appendChild(pronRow);

    const row = document.createElement('div'); row.className='row';
    const btn = document.createElement('button'); btn.className='pill'; btn.textContent='정답';
    btn.addEventListener('click',()=>{ 
      a.classList.toggle('hidden'); 
      btn.textContent = a.classList.contains('hidden') ? '정답' : '가리기'; 
    });
    row.appendChild(btn);

    wrap.appendChild(q); 
    wrap.appendChild(a); 
    wrap.appendChild(row);
    return wrap;
  }

  function render(data){
    listEl.innerHTML='';
    const repeat = Math.max(1, parseInt($('repeatInput').value||'1', 10));
    const items = [];
    for(let r=0;r<repeat;r++) items.push(...data);
    items.forEach(it=> listEl.appendChild(makeCard(it)) );
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){ 
      const j=Math.floor(Math.random()*(i+1)); 
      [arr[i],arr[j]]=[arr[j],arr[i]]; 
    }
  }

  $('shuffleBtn').onclick = ()=>{ shuffle(baseData); render(baseData); };
  $('repeatInput').addEventListener('change', ()=> render(baseData));
  $('revealAll').onclick = ()=>{
    document.querySelectorAll('.answer').forEach(el=>el.classList.remove('hidden'));
    document.querySelectorAll('.pill').forEach(b=>b.textContent='가리기');
  };
  $('hideAll').onclick = ()=>{
    document.querySelectorAll('.answer').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.pill').forEach(b=>b.textContent='정답');
  };

  // 공통: 엑셀 rows를 우리가 쓰는 형식으로 변환
  function normalizeRows(rows){
    return rows.map(r=>({
      일본어: r['일본어'] ?? r['A'] ?? r[Object.keys(r)[0]] ?? '',
      뜻:    r['뜻']    ?? r['B'] ?? r[Object.keys(r)[1]] ?? '',
      발음:  r['발음']  ?? r['C'] ?? r[Object.keys(r)[2]] ?? '',
    })).filter(x=>x.일본어);
  }

  // 페이지 로드 시 같은 폴더의 japanese.xlsx 자동 로딩
  async function loadDefaultXlsx(){
    try{
      const res = await fetch('japanese.xlsx');
      if(!res.ok){
        console.warn('japanese.xlsx 요청 실패, 기본 데이터 사용');
        return;
      }
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const normalized = normalizeRows(rows);
      if(normalized.length){
        baseData = normalized;
      }else{
        console.warn('japanese.xlsx 내용이 비어있어서 기본 데이터 사용');
      }
    }catch(err){
      console.error('japanese.xlsx 자동 로딩 중 오류:', err);
    }
  }

  // 파일 선택으로 업로드하는 경우
  $('xlsxInput').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; 
    if(!file) return;
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    const normalized = normalizeRows(rows);
    if(normalized.length){ 
      baseData = normalized; 
      render(baseData); 
    }
    else alert('엑셀을 읽지 못했어요. A=일본어, B=뜻, C=발음인지 확인해주세요.');
    e.target.value = '';
  });

  // 초기 실행: 엑셀 시도 후 렌더
  (async ()=>{
    await loadDefaultXlsx();
    render(baseData);
  })();
</script>
</body>
</html>

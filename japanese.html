<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>일본어 작문 연습 · 문제=일본어 / 정답=뜻·발음</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* CSS 스타일: 사용자 지정 변수 및 기본 스타일 */
:root{ --bg:#f7f9fc; --text:#0f172a; --muted:#5b6476; --card:#ffffff; --ring:#d9e1ff; --accent:#2563eb; --shadow:0 10px 30px rgba(7,14,48,.06); }
*{ box-sizing:border-box }
body{ margin:0; font-family:Pretendard, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; background:var(--bg); color:var(--text); line-height:1.6 }
.container{ max-width:900px; margin:26px auto; padding:0 16px }
h1{ margin:0 0 12px; font-size:28px }
/* 툴바 스타일 */
.toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px }
.btn{ border:1px solid #cfd7ee; background:#fff; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; box-shadow:var(--shadow); transition: all 0.2s }
.btn:hover{ background:#f3f6ff }
.btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
.btn.primary:hover{ background:#1d4ed8 }
.btn.ghost{ background:#f6f8ff }
input[type="number"]{ width:72px; padding:8px 10px; border:1px solid #d4dcf4; border-radius:10px; font-weight:600; box-shadow:var(--shadow) }
.hint{ color:var(--muted); font-size:13px }

/* 카드 및 문제/정답 스타일 */
.card{ background:var(--card); border:1px solid #e6ecff; border-radius:16px; padding:14px; box-shadow:var(--shadow); margin:18px 0 }
.question{ font-size:22px; font-weight:800; letter-spacing:.2px; padding:16px; border:1px solid #e4e9fb; border-radius:12px; background:#fbfdff; color:#2563eb; /* 문제(일본어) 강조 */ }
.answer{ position:relative; margin-top:14px; padding:18px; border-radius:12px; background:#f7f9ff; color:var(--text); border:1px dashed #cdd7fb }
.answer.hidden .blur{ filter: blur(7px); opacity:.65; transition: filter 0.3s, opacity 0.3s }
.answer .label{ font-size:12px; color:var(--muted); margin-bottom:6px }
.answer .line{ font-size:18px; font-weight:700 }
.row{ display:flex; justify-content:flex-end; margin-top:12px }
.pill{ border:1px solid #d4dcf4; background:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition: all 0.2s }
.pill:hover{ background:#f3f6ff }
.top-note{ margin:4px 0 18px; font-size:12px; color:var(--muted) }
input[type=file]{ display:none }

/* 모바일 대응 */
@media (max-width: 600px) {
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    .toolbar > * {
        margin: 5px 0 !important;
    }
    input[type="number"] {
        width: 100%;
    }
    .hint {
        text-align: center;
        margin: 0 !important;
    }
    .row {
        justify-content: center;
    }
}
</style>
</head>
<body>
  <div class="container">
    <h1>일본어 작문 연습</h1>
    <div class="toolbar">
      <button class="btn primary" id="shuffleBtn">무작위 섞기</button>
      <label class="hint">반복:</label>
      <input id="repeatInput" type="number" min="1" value="1" />
      <label class="btn" for="xlsxInput">파일 선택 (재로딩)</label>
      <input id="xlsxInput" type="file" accept=".xlsx,.xls" />
      <button class="btn ghost" id="revealAll">전체 정답 보기</button>
      <button class="btn ghost" id="hideAll">전체 가리기</button>
      <span id="dataStatus" class="top-note"></span>
    </div>

    <div id="list"></div>
  </div>

<script>
  // 기본 데이터 (엑셀 로딩 실패 시 사용되는 fallback)
  let baseData = [
    { 일본어: 'さすが', 뜻: '역시', 발음: '사스가' },
    { 일본어: 'えらい', 뜻: '대단해', 발음: '에라이' },
    { 일본어: 'すばらしい', 뜻: '훌륭해', 발음: '스바라시' },
  ];
  
  const $ = (id) => document.getElementById(id);
  const listEl = $('list');
  const dataStatusEl = $('dataStatus');

  // --- 1. 카드 생성 함수 ---
  function makeCard(item){
    const wrap = document.createElement('div');
    wrap.className = 'card';

    // 문제 영역 (일본어 원문)
    const q = document.createElement('div');
    q.className = 'question';
    // A열의 데이터를 사용
    q.textContent = item.일본어; 

    // 정답 영역 (뜻과 발음, 초기에는 숨김/블러 처리)
    const a = document.createElement('div');
    a.className = 'answer hidden';

    // B열: 뜻
    const meanRow = document.createElement('div');
    meanRow.innerHTML = `<div class="label">뜻</div><div class="line blur">${item.뜻}</div>`;

    // C열: 발음
    const pronRow = document.createElement('div');
    pronRow.style.marginTop = '8px';
    pronRow.innerHTML = `<div class="label">발음 (후리가나)</div><div class="line blur">${item.발음}</div>`;

    a.appendChild(meanRow); a.appendChild(pronRow);

    // 정답 보기/가리기 버튼
    const row = document.createElement('div'); row.className='row';
    const btn = document.createElement('button'); btn.className='pill'; btn.textContent='정답';
    
    btn.addEventListener('click', ()=>{ 
      a.classList.toggle('hidden'); 
      btn.textContent = a.classList.contains('hidden') ? '정답' : '가리기'; 
    });
    row.appendChild(btn);

    wrap.appendChild(q); 
    wrap.appendChild(a); 
    wrap.appendChild(row);
    return wrap;
  }

  // --- 2. 렌더링 함수 ---
  function render(data){
    listEl.innerHTML='';
    const repeat = Math.max(1, parseInt($('repeatInput').value||'1', 10));
    const items = [];
    
    // 반복 횟수만큼 데이터 복사
    for(let r=0;r<repeat;r++) items.push(...data);
    
    items.forEach(it=> listEl.appendChild(makeCard(it)) );
    dataStatusEl.textContent = `총 ${data.length}개 어휘 (반복 ${repeat}회) 로드 완료.`;
  }

  // --- 3. 유틸리티 함수 ---
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){ 
      const j=Math.floor(Math.random()*(i+1)); 
      [arr[i],arr[j]]=[arr[j],arr[i]]; 
    }
  }
  
  // 엑셀 rows를 우리가 쓰는 {일본어, 뜻, 발음} 형식으로 변환
  function normalizeRows(rows){
    if (rows.length === 0) return [];
    
    // 엑셀의 첫 번째 행(헤더)을 키로 사용 (XLSX.utils.sheet_to_json 기본 동작)
    return rows.map(r=>{
      const keys = Object.keys(r);
      return {
        // A열, B열, C열의 데이터를 각각 일본어, 뜻, 발음으로 매핑
        일본어: r[keys[0]] ?? '', // A열
        뜻:    r[keys[1]] ?? '', // B열
        발음:  r[keys[2]] ?? '', // C열
      }
    }).filter(x => x.일본어); // 일본어(A열)가 있는 유효한 행만 사용
  }
  
  // --- 4. 이벤트 리스너 ---
  
  // 무작위 섞기 버튼
  $('shuffleBtn').onclick = ()=>{ shuffle(baseData); render(baseData); };
  
  // 반복 횟수 변경
  $('repeatInput').addEventListener('change', ()=> render(baseData));
  
  // 전체 정답 보기
  $('revealAll').onclick = ()=>{
    document.querySelectorAll('.answer').forEach(el=>el.classList.remove('hidden'));
    document.querySelectorAll('.pill').forEach(b=>b.textContent='가리기');
  };
  
  // 전체 가리기
  $('hideAll').onclick = ()=>{
    document.querySelectorAll('.answer').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.pill').forEach(b=>b.textContent='정답');
  };

  // 엑셀 파일 업로드 및 처리
  $('xlsxInput').addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; 
    if(!file) return;

    try {
      dataStatusEl.textContent = `"${file.name}" 파일을 읽는 중...`;
      
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      // header: 1 을 제거하여 첫 번째 행을 헤더(키)로 사용
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''}); 
      const normalized = normalizeRows(rows);
      
      if(normalized.length){ 
        baseData = normalized; 
        render(baseData); 
        dataStatusEl.textContent = `"${file.name}" 로드 완료. (총 ${baseData.length}개 어휘)`;
      } else {
        alert('엑셀을 읽었으나 유효한 데이터가 없습니다. A=일본어, B=뜻, C=발음 순서인지 확인해주세요.');
        dataStatusEl.textContent = '유효한 엑셀 데이터를 찾을 수 없습니다.';
      }
    } catch (err) {
      console.error('파일 처리 오류:', err);
      alert('엑셀 파일을 처리하는 도중 오류가 발생했습니다.');
      dataStatusEl.textContent = '파일 처리 중 오류 발생.';
    }
    e.target.value = ''; // 같은 파일 재선택을 위해 초기화
  });

  // --- 5. 초기 실행 (같은 폴더의 japanese.xlsx 자동 로딩 시도) ---
  (async ()=>{
    try{
      // fetch로 같은 폴더의 파일을 요청 (웹 서버 환경이나 Live Server 필요)
      const res = await fetch('japanese.xlsx');
      if(!res.ok){
        throw new Error('파일을 찾거나 읽을 수 없습니다. (HTTP Status: ' + res.status + ')');
      }
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      const normalized = normalizeRows(rows);
      
      if(normalized.length){
        baseData = normalized;
        dataStatusEl.innerHTML = `**japanese.xlsx** 자동 로드 완료.`;
      }else{
        throw new Error('엑셀 파일의 내용이 비어있습니다.');
      }
    }catch(err){
      console.warn('japanese.xlsx 자동 로딩 실패:', err.message);
      dataStatusEl.innerHTML = '<b>japanese.xlsx</b> 자동 로드 실패. 기본 데이터 사용.';
    }
    render(baseData);
  })();
</script>
</body>
</html>
